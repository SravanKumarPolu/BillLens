apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

// Override autolinking task for pnpm compatibility
afterEvaluate {
    def autolinkTask = tasks.findByName("generateAutolinkingPackageList")
    if (autolinkTask) {
        // Create required directories
        def autolinkDir = new File(project.buildDir, "generated/autolinking")
        autolinkDir.mkdirs()
        
        // Create required input file
        def inputFile = new File(autolinkDir, "autolinking.json")
        if (!inputFile.exists()) {
            inputFile.write('{}')
        }
        
        // Create output file
        def outputFile = new File(autolinkDir, "package-list.json")
        
        autolinkTask.actions.clear()
        autolinkTask.doFirst {
            def jsonContent = """{
  "project": {
    "android": {
      "packageName": "com.billlens"
    }
  },
  "dependencies": {}
}"""
            outputFile.write(jsonContent)
        }
        
        // Ensure output file exists even if task fails
        autolinkTask.doLast {
            if (!outputFile.exists()) {
                def jsonContent = """{
  "project": {
    "android": {
      "packageName": "com.billlens"
    }
  },
  "dependencies": {}
}"""
                outputFile.write(jsonContent)
            }
        }
        
        // Set input file property if it exists
        try {
            autolinkTask.autolinkInputFile = inputFile
        } catch (Exception e) {
            // Property might not exist in all RN versions, ignore
        }
    }
}

// React Native configuration
// Autolinking disabled for pnpm compatibility - using manual linking
react {
    // autolinkLibrariesWithApp() // Disabled - see dependencies block below
    entryFile = file("../../index.tsx")
}

// Proguard configuration
def enableProguardInReleaseBuilds = false

// JavaScriptCore flavor (use 'org.webkit:android-jsc-intl:+' for international variant)
def jscFlavor = 'org.webkit:android-jsc:+'

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.billlens"
    defaultConfig {
        applicationId "com.billlens"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            // TODO: Generate production keystore for release builds
            // See: https://reactnative.dev/docs/signed-apk-android
            signingConfig signingConfigs.debug
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

// Task to wait for emulator to be ready before installation
afterEvaluate {
    tasks.matching { it.name.startsWith("install") && (it.name.contains("Debug") || it.name.contains("Release")) }.all { installTask ->
        installTask.doFirst {
            println "Checking if emulator is ready..."
            def maxAttempts = 60
            def attempt = 0
            
            while (attempt < maxAttempts) {
                try {
                    def devices = "adb devices".execute().text
                    if (devices.contains("device")) {
                        def bootCompleted = "adb shell getprop sys.boot_completed".execute().text.trim()
                        if (bootCompleted == "1") {
                            println "✓ Emulator is ready!"
                            return
                        }
                    }
                } catch (Exception e) {
                    // Ignore errors and retry
                }
                
                attempt++
                if (attempt < maxAttempts) {
                    sleep(1000) // Wait 1 second
                    if (attempt % 10 == 0) {
                        println "Waiting for emulator... (${attempt}/${maxAttempts})"
                    }
                }
            }
            
            println "⚠ Warning: Emulator may not be fully ready. Installation may fail."
            println "   If installation fails, wait a few seconds and try again, or run:"
            println "   ./android/wait-for-emulator.sh"
        }
    }
}

dependencies {
    // The version of react-native is set by the React Native Gradle Plugin
    implementation("com.facebook.react:react-android")

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
    
    // Manually linked native modules
    implementation project(':react-native-async-storage_async-storage')
    implementation project(':react-native-image-picker')
    implementation project(':react-native-safe-area-context')
    implementation project(':react-native-screens')
    implementation project(':react-native-html-to-pdf')
    implementation project(':react-native-fs')
}
